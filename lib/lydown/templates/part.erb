<%
  if name && (name != '')
    part_title = Lydown::Rendering::Staff.part_title(self, name)
    inline_part_title = Lydown::Rendering::Staff.inline_part_title(
      self, part: name
    )
    voice_prefix = "#{name}_"
  else
    part_title = "#\"\""
    voice_prefix = nil
  end
  staff_id = Lydown::Rendering::Staff.staff_id(name)

  score_mode = self['render_opts/mode'] == :score
  
  part['settings'] ||= {
    'pickup' => self[:pickup],
    'key' => self[:key],
    'tempo' => self[:tempo]
  }.deep!

  clef = Lydown::Rendering::Staff.clef(name)
  prevent_remove_empty = Lydown::Rendering::Staff.prevent_remove_empty(name)
  
  midi_mode = (self['render_opts/format'] == 'midi') ||
              (self['render_opts/format'] == 'mp3')
  midi_instrument = midi_mode && Lydown::Rendering::Staff.midi_instrument(name)
  
  beaming_mode = Lydown::Rendering::Staff.beaming_mode(name)
  partial = part['settings'][:pickup] ? "\\partial #{part['settings'][:pickup]}" : ""
  
  end_barline = Lydown::Rendering::Staff.end_barline(self, movement)

  cadenza = part['settings'][:time] == 'unmetered'
  
  mode = self['render_opts/mode'] || self['mode']
  skip_bars = (mode == :proof) || (mode == :part)

  instrument_names = self['instrument_names'] || movement['settings/instrument_names']
  hide_instrument_names = 
    (instrument_names == 'hide') || 
    (instrument_names == 'inline')
%>

<<

\new Staff = <%= staff_id %> \with {
  <% if prevent_remove_empty %>
    \override VerticalAxisGroup.remove-empty = ##f
  <% end %>
}

\context Staff = <%= staff_id %> {
  <% if skip_bars %>
    \set Score.skipBars = ##t
  <% end %>
    

  <% if part['settings'][:tempo] %>
    \tempo "<%= part['settings'][:tempo] %>"
  <% end %>

<% if score_mode && !hide_instrument_names %>
  \set Staff.instrumentName = <%= part_title %>
<% end %>

<% if midi_instrument %>
  \set Staff.midiInstrument = #"<%= midi_instrument %>"
<% end %>

  \relative c {
    <% if clef %>
        \clef "<%= clef %>"
    <% end %>
    <%= partial %>
    
    <% if (mode == :score) && (instrument_names == 'inline') %>
      <%= inline_part_title %>
    <% end %>
    
    <<
      \new Voice = "<%= voice_prefix %>voice1" {
        <%= beaming_mode %>
        <%= part['music'] %>
      }
    >>
    <% if end_barline %>
      \bar "<%= end_barline %>"
    <% end %>
  }
}

  <% if part['lyrics'] %>
    <% multi_voice = part['lyrics'].size > 1 %>
    <% part['lyrics'].each_key do |voice| %>
      <% above_staff = multi_voice && ['voice1', 'voice3'].include?(voice) %>
      <% part['lyrics'][voice].keys.sort.each do |idx| %>
        \new Lyrics 
        <% if above_staff %>
          \with { alignAboveContext = "<%= staff_id %>" }
        <% end %>
        {
          \lyricsto "<%= voice_prefix %><%= voice %>" {
            <%= part['lyrics'][voice][idx] %>
          }
        }
      <% end %>
    <% end %>
  
  <% end %>

  <% if part['figures'] %>
    \figures { <%= part['figures'] %> }
  <% end %>
>>
