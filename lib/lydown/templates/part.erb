<%
  setting_opts = {movement: movement_name, part: name}

  inline_part_title = nil
  if name && (name != '')
    part_title = Lydown::Rendering::Staff.part_title(self, setting_opts)
    voice_prefix = "#{name}_"
  else
    part_title = "#\"\""
    voice_prefix = nil
  end
  staff_id = Lydown::Rendering::Staff.staff_id(name)

  score_mode = self['render_opts/mode'] == :score
  
  clef = Lydown::Rendering::Staff.clef(self, setting_opts)
  prevent_remove_empty = Lydown::Rendering::Staff.prevent_remove_empty(self, setting_opts) == false
  
  midi_mode = (self['render_opts/format'] == 'midi') ||
              (self['render_opts/format'] == 'mp3')
  midi_instrument = midi_mode && Lydown::Rendering::Staff.midi_instrument(name)
  
  beaming_mode = Lydown::Rendering::Staff.beaming_mode(self, setting_opts)
  partial = self.get_setting(:pickup, setting_opts)
  partial = partial ? "\\partial #{partial}" : ""
  
  end_barline = Lydown::Rendering::Staff.end_barline(self, setting_opts)

  time = self.get_setting(:time, setting_opts)
  cadenza = time == 'unmetered'
  
  mode = self['render_opts/mode'] || self['mode']
  skip_bars = (mode == :proof) || (mode == :part)

  instrument_names = self.get_setting(:instrument_names, setting_opts)
  hide_instrument_names = 
    (instrument_names == 'hide') || 
    (instrument_names =~ /^inline\-?(.+)?$/)
    
  if instrument_names =~ /^inline\-?(.+)?$/
    alignment = $1 && "\\#{$1}"
    inline_part_title = Lydown::Rendering::Staff.inline_part_title(
      self, setting_opts.merge(alignment: alignment)
    )
  end
%>

<<

\new Staff = <%= staff_id %> \with {
  <% if prevent_remove_empty %>
    \override VerticalAxisGroup.remove-empty = ##f
  <% end %>
}

\context Staff = <%= staff_id %> {
  <% if skip_bars %>
    \set Score.skipBars = ##t
  <% end %>
    

  <% if tempo = self.get_setting(:tempo, setting_opts) %>
    \tempo "<%= tempo %>"
  <% end %>

<% if score_mode && !hide_instrument_names %>
  \set Staff.instrumentName = <%= part_title %>
<% end %>

<% if midi_instrument %>
  \set Staff.midiInstrument = #"<%= midi_instrument %>"
<% end %>

  <% if clef %>
      \clef "<%= clef %>"
  <% end %>
  <%= partial %>

  <% if (mode == :score) && inline_part_title %>
    <%= inline_part_title %>
  <% end %>
  
  <%= beaming_mode %>
  \<%= Lydown::Rendering.variable_name(setting_opts.merge(stream: :music)) %>
  
  <% if end_barline %>
    \bar "<%= end_barline %>"
  <% end %>
}

<% if part['lyrics'] %>
  <% multi_voice = part['lyrics'].size > 1 %>
  <% part['lyrics'].each_key do |voice| %>
    <% above_staff = multi_voice && ['voice1', 'voice3'].include?(voice) %>
    <% part['lyrics'][voice].keys.sort.each do |idx| %>
      \new Lyrics 
      <% if above_staff %>
        \with { alignAboveContext = "<%= staff_id %>" }
      <% end %>
      {
        \lyricsto "<%= voice_prefix %><%= voice %>" {
          \<%= Lydown::Rendering.variable_name(setting_opts.merge(stream: :lyrics, voice: voice, idx: idx)) %>
        }
      }
    <% end %>
  <% end %>

<% end %>

<% if part['figures'] %>
  \new FiguredBass { \<%= Lydown::Rendering.variable_name(setting_opts.merge(stream: :figures)) %> }
<% end %>
>>
