<%
  title = nil
  if name && (name != '')
    title = Lydown::Rendering.part_title(name)
  end
  id = "#{title && title.gsub(' ', '')}Staff"

  score_mode = self['render_opts/mode'] == :score

  clef = Lydown::Rendering::Staff.clef(name)
  beaming_mode = Lydown::Rendering::Staff.beaming_mode(name)
  partial = self[:pickup] ? "\\partial #{self[:pickup]}" : ""

  end_barline = Lydown::Rendering::Staff.end_barline(self, movement)

  cadenza = self[:time] == 'unmetered'
%>

<<

<% if self[:tempo] %>
  \tempo "<%= self[:tempo] %>"
<% end %>

\new Staff = <%= id %> \with {
}

\context Staff = <%= id %> {
<% if score_mode %>\set Staff.instrumentName = #"<%= title %>"<% end %>
  \relative c {
    <% if clef %>
        \clef "<%= clef %>"
    <% end %>
    <%= beaming_mode %>
    <%= partial %>
    
    <<
      \new Voice = "voice1" {
        <%= part['music'] %>
      }
    >>
    <% if end_barline %>
      \bar "<%= end_barline %>"
    <% end %>
  }
}

  <% if part['lyrics'] %>
    <% part['lyrics'].each_key do |voice| %>
      <% part['lyrics'][voice].keys.sort.each do |idx| %>
        \new Lyrics \lyricsto "<%= voice %>" {
          <%= part['lyrics'][voice][idx] %>
        }
      <% end %>
    <% end %>
  
  <% end %>

  <% if part['figures'] %>
    \figures { <%= part['figures'] %> }
  <% end %>
>>
