<%
  title = nil
  if name && (name != '')
    title = Lydown::Rendering.part_title(name)
    voice_prefix = "#{name}_"
  else
    title = nil
    voice_prefix = nil
  end
  staff_id = "#{title && title.gsub(' ', '')}Staff"
  

  score_mode = self['render_opts/mode'] == :score
  
  part['settings'] ||= {
    'pickup' => @context[:pickup],
    'key' => @context[:key],
    'tempo' => @context[:tempo]
  }.deep!

  clef = Lydown::Rendering::Staff.clef(name)
  beaming_mode = Lydown::Rendering::Staff.beaming_mode(name)
  partial = part['settings'][:pickup] ? "\\partial #{part['settings'][:pickup]}" : ""
  
  end_barline = Lydown::Rendering::Staff.end_barline(self, movement)

  cadenza = part['settings'][:time] == 'unmetered'
%>

<<

<% if part['settings'][:tempo] %>
  \tempo "<%= part['settings'][:tempo] %>"
<% end %>

\new Staff = <%= staff_id %> \with {
}

\context Staff = <%= staff_id %> {
<% if score_mode %>\set Staff.instrumentName = #"<%= title %>"<% end %>
  \relative c {
    <% if clef %>
        \clef "<%= clef %>"
    <% end %>
    <%= partial %>
    
    <<
      \new Voice = "<%= voice_prefix %>voice1" {
        <%= beaming_mode %>
        <%= part['music'] %>
      }
    >>
    <% if end_barline %>
      \bar "<%= end_barline %>"
    <% end %>
  }
}

  <% if part['lyrics'] %>
    <% multi_voice = part['lyrics'].size > 1 %>
    <% part['lyrics'].each_key do |voice| %>
      <% above_staff = multi_voice && ['voice1', 'voice3'].include?(voice) %>
      <% part['lyrics'][voice].keys.sort.each do |idx| %>
        \new Lyrics 
        <% if above_staff %>
          \with { alignAboveContext = "<%= staff_id %>" }
        <% end %>
        {
          \lyricsto "<%= voice_prefix %><%= voice %>" {
            <%= part['lyrics'][voice][idx] %>
          }
        }
      <% end %>
    <% end %>
  
  <% end %>

  <% if part['figures'] %>
    \figures { <%= part['figures'] %> }
  <% end %>
>>
