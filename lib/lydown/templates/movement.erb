<%
  render_mode = self['render_opts/mode']
  score_mode = (render_mode == :score) || (render_mode == :proof)
  staff_groups = Lydown::Rendering::Staff.staff_groups(
    self, movement, movement['parts'].keys)
  parts_in_order = staff_groups.flatten
  staff_hierarchy = Lydown::Rendering::Staff.staff_hierarchy(staff_groups)
    
  parts = parts_in_order.inject({}) do |m, p|
    m[p] = movement['parts'][p]
    m
  end
  
  movement_title = Lydown::Rendering::Movement.movement_title(self, name)
  
  format = self['options/format'] || self['render_opts/format'] || :pdf
  midi_mode = (format == :midi) || (format == :mp3)
  
  empty_staves = self['empty_staves'] || movement['settings/empty_staves']
  
    
  page_breaks = Lydown::Rendering::Movement.page_breaks(self)
%>
<% if page_breaks[:before] %>\pageBreak <% end %>
\score {
  <% if movement_title %>
    \header { 
      piece = \markup { \bold \large { <%= movement_title %> } }
    }
  <% end %>
  
  <% if score_mode %>
    <% if empty_staves == 'hide' %>
      \layout {
        \context {
          \RemoveEmptyStaffContext
          \override VerticalAxisGroup #'remove-first = ##t
        }
      }      
    <% end %>
    
    \new StaffGroup <<
      \set StaffGroup.systemStartDelimiterHierarchy = <%= staff_hierarchy %>
  <% end %>
    
      <% if n = movement['bar_number'] %>
        \set Score.currentBarNumber = #<%= n %>
        \set Score.barNumberVisibility = #all-bar-numbers-visible
        \bar ""
      <% end %>
      
      <% parts.each do |n, p| %>
        <%= Lydown::Templates.render(:part, self, 
          name: n, part: p, movement: movement, movement_name: name) %>
      <% end %>
  
  <% if score_mode %>
    >>
  <% end %>
  <% if midi_mode %>
  \midi {
    <% if tempo = movement['settings/midi_tempo'] %>
      \tempo <%= tempo %>
    <% end %>
  }
  <% end %> 
}
<% if page_breaks[:after] %>\pageBreak <% end %>
